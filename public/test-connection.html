<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿æ¥æµ‹è¯• - è¿åŠ¨ä¼šç®¡ç†ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #40a9ff;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .info {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        .config-info {
            background-color: #fafafa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .loading {
            color: #1890ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸƒâ€â™‚ï¸ è¿åŠ¨ä¼šç®¡ç†ç³»ç»Ÿ - è¿æ¥æµ‹è¯•</h1>
        
        <div class="config-info">
            <h3>ğŸ“‹ å½“å‰é…ç½®ä¿¡æ¯</h3>
            <div id="config-info">
                <p><strong>å½“å‰URL:</strong> <span id="current-url"></span></p>
                <p><strong>ä¸»æœºå:</strong> <span id="hostname"></span></p>
                <p><strong>ç«¯å£:</strong> <span id="port"></span></p>
                <p><strong>åè®®:</strong> <span id="protocol"></span></p>
                <p><strong>é¢„æœŸAPIåœ°å€:</strong> <span id="expected-api"></span></p>
            <p><strong>æ¨èç«¯å£:</strong> å‰ç«¯: 3456, åç«¯: 3457</p>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ” APIè¿æ¥æµ‹è¯•</h3>
            <button class="test-button" onclick="testHealthCheck()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
            <button class="test-button" onclick="testDataFetch()">æµ‹è¯•æ•°æ®è·å–</button>
            <button class="test-button" onclick="testCORS()">æµ‹è¯•CORS</button>
            <div id="api-results" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ é™æ€æ–‡ä»¶æµ‹è¯•</h3>
            <button class="test-button" onclick="testStaticFiles()">æµ‹è¯•é™æ€æ–‡ä»¶è®¿é—®</button>
            <div id="static-results" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸŒ ç½‘ç»œè¯Šæ–­</h3>
            <button class="test-button" onclick="diagnoseNetwork()">ç½‘ç»œè¯Šæ–­</button>
            <div id="network-results" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>âš¡ å¿«é€Ÿä¿®å¤å»ºè®®</h3>
            <div id="suggestions" class="result info" style="display: none;"></div>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰é…ç½®ä¿¡æ¯
        function displayConfigInfo() {
            document.getElementById('current-url').textContent = window.location.href;
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('port').textContent = window.location.port || '80';
            document.getElementById('protocol').textContent = window.location.protocol;
            
            const expectedApi = window.location.origin + '/api/health';
            document.getElementById('expected-api').textContent = expectedApi;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // æµ‹è¯•å¥åº·æ£€æŸ¥
        async function testHealthCheck() {
            const resultDiv = document.getElementById('api-results');
            showResult('api-results', 'æ­£åœ¨æµ‹è¯•å¥åº·æ£€æŸ¥...', 'loading');
            
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok) {
                    showResult('api-results', `
                        <strong>âœ… å¥åº·æ£€æŸ¥æˆåŠŸï¼</strong><br>
                        çŠ¶æ€: ${data.status}<br>
                        æ—¶é—´æˆ³: ${data.timestamp}<br>
                        æ•°æ®æ–‡ä»¶: ${data.dataFile}<br>
                        HTTPçŠ¶æ€: ${response.status}
                    `, 'success');
                    generateSuggestions();
                } else {
                    showResult('api-results', `
                        <strong>âŒ å¥åº·æ£€æŸ¥å¤±è´¥</strong><br>
                        HTTPçŠ¶æ€: ${response.status}<br>
                        é”™è¯¯: ${JSON.stringify(data)}
                    `, 'error');
                }
            } catch (error) {
                showResult('api-results', `
                    <strong>âŒ è¿æ¥å¤±è´¥</strong><br>
                    é”™è¯¯ç±»å‹: ${error.name}<br>
                    é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                    è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€
                `, 'error');
            }
        }

        // æµ‹è¯•æ•°æ®è·å–
        async function testDataFetch() {
            showResult('api-results', 'æ­£åœ¨æµ‹è¯•æ•°æ®è·å–...', 'loading');
            
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                if (response.ok) {
                    const hasGames = data.games && Object.keys(data.games).length > 0;
                    const hasPlayers = data.players && Object.keys(data.players).length > 0;
                    
                    showResult('api-results', `
                        <strong>âœ… æ•°æ®è·å–æˆåŠŸï¼</strong><br>
                        æ¸¸æˆæ•°æ®: ${hasGames ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}<br>
                        é€‰æ‰‹æ•°æ®: ${hasPlayers ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}<br>
                        HTTPçŠ¶æ€: ${response.status}<br>
                        æ•°æ®å¤§å°: ${JSON.stringify(data).length} å­—ç¬¦
                    `, 'success');
                } else {
                    showResult('api-results', `
                        <strong>âŒ æ•°æ®è·å–å¤±è´¥</strong><br>
                        HTTPçŠ¶æ€: ${response.status}<br>
                        é”™è¯¯: ${JSON.stringify(data)}
                    `, 'error');
                }
            } catch (error) {
                showResult('api-results', `
                    <strong>âŒ æ•°æ®è·å–å¤±è´¥</strong><br>
                    é”™è¯¯ç±»å‹: ${error.name}<br>
                    é”™è¯¯ä¿¡æ¯: ${error.message}
                `, 'error');
            }
        }

        // æµ‹è¯•CORS
        async function testCORS() {
            showResult('api-results', 'æ­£åœ¨æµ‹è¯•CORS...', 'loading');
            
            try {
                // å°è¯•ä»ä¸åŒæºå¤´å‘é€è¯·æ±‚
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                showResult('api-results', `
                    <strong>CORSæµ‹è¯•ç»“æœ:</strong><br>
                    HTTPçŠ¶æ€: ${response.status}<br>
                    Access-Control-Allow-Origin: ${corsHeaders['Access-Control-Allow-Origin'] || 'æœªè®¾ç½®'}<br>
                    Access-Control-Allow-Credentials: ${corsHeaders['Access-Control-Allow-Credentials'] || 'æœªè®¾ç½®'}<br>
                    Access-Control-Allow-Methods: ${corsHeaders['Access-Control-Allow-Methods'] || 'æœªè®¾ç½®'}<br>
                    Access-Control-Allow-Headers: ${corsHeaders['Access-Control-Allow-Headers'] || 'æœªè®¾ç½®'}
                `, response.ok ? 'success' : 'error');
                
            } catch (error) {
                showResult('api-results', `
                    <strong>âŒ CORSæµ‹è¯•å¤±è´¥</strong><br>
                    é”™è¯¯ç±»å‹: ${error.name}<br>
                    é”™è¯¯ä¿¡æ¯: ${error.message}
                `, 'error');
            }
        }

        // æµ‹è¯•é™æ€æ–‡ä»¶
        async function testStaticFiles() {
            showResult('static-results', 'æ­£åœ¨æµ‹è¯•é™æ€æ–‡ä»¶è®¿é—®...', 'loading');
            
            const testFiles = [
                '/data/sports_data.json',
                '/favicon.ico',
                '/manifest.json'
            ];
            
            const results = [];
            
            for (const file of testFiles) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    results.push({
                        file: file,
                        status: response.status,
                        ok: response.ok,
                        contentType: response.headers.get('Content-Type')
                    });
                } catch (error) {
                    results.push({
                        file: file,
                        status: 'ERROR',
                        ok: false,
                        error: error.message
                    });
                }
            }
            
            let html = '<strong>é™æ€æ–‡ä»¶æµ‹è¯•ç»“æœ:</strong><br>';
            results.forEach(result => {
                const status = result.ok ? 'âœ…' : 'âŒ';
                html += `${status} ${result.file} - HTTP ${result.status}`;
                if (result.contentType) {
                    html += ` (${result.contentType})`;
                }
                if (result.error) {
                    html += ` - ${result.error}`;
                }
                html += '<br>';
            });
            
            const allOk = results.every(r => r.ok);
            showResult('static-results', html, allOk ? 'success' : 'error');
        }

        // ç½‘ç»œè¯Šæ–­
        async function diagnoseNetwork() {
            showResult('network-results', 'æ­£åœ¨è¿›è¡Œç½‘ç»œè¯Šæ–­...', 'loading');
            
            const diagnostics = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                online: navigator.onLine,
                connection: navigator.connection || 'ä¸æ”¯æŒ',
                currentUrl: window.location.href,
                hostname: window.location.hostname,
                protocol: window.location.protocol,
                port: window.location.port || '80'
            };
            
            // æµ‹è¯•DNSè§£æ
            const dnsTest = await testDNS();
            
            let html = '<strong>ç½‘ç»œè¯Šæ–­ç»“æœ:</strong><br>';
            html += `æ—¶é—´æˆ³: ${diagnostics.timestamp}<br>`;
            html += `åœ¨çº¿çŠ¶æ€: ${diagnostics.online ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}<br>`;
            html += `åè®®: ${diagnostics.protocol}<br>`;
            html += `ä¸»æœºå: ${diagnostics.hostname}<br>`;
            html += `ç«¯å£: ${diagnostics.port}<br>`;
            html += `DNSæµ‹è¯•: ${dnsTest}<br>`;
            
            showResult('network-results', html, 'info');
        }

        // DNSæµ‹è¯•
        async function testDNS() {
            try {
                const start = Date.now();
                await fetch(window.location.origin + '/favicon.ico', { 
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                const duration = Date.now() - start;
                return `âœ… æˆåŠŸ (${duration}ms)`;
            } catch (error) {
                return `âŒ å¤±è´¥ - ${error.message}`;
            }
        }

        // ç”Ÿæˆä¿®å¤å»ºè®®
        function generateSuggestions() {
            const suggestions = [];
            
            if (window.location.protocol === 'https:') {
                suggestions.push('âœ… ä½¿ç”¨HTTPSåè®®ï¼Œå®‰å…¨æ€§è‰¯å¥½');
            } else {
                suggestions.push('âš ï¸ ä½¿ç”¨HTTPåè®®ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨HTTPS');
            }
            
            if (window.location.hostname === 'localhost') {
                suggestions.push('â„¹ï¸ å½“å‰ä¸ºæœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œç¡®ä¿åç«¯æœåŠ¡åœ¨ç«¯å£3457è¿è¡Œ');
            } else {
                suggestions.push('â„¹ï¸ å½“å‰ä¸ºè¿œç¨‹ç¯å¢ƒï¼Œç¡®ä¿CORSé…ç½®æ­£ç¡®');
            }
            
            suggestions.push('ğŸ’¡ å¦‚æœAPIè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š');
            suggestions.push('  - åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ');
            suggestions.push('  - CORS_ORIGINSç¯å¢ƒå˜é‡æ˜¯å¦åŒ…å«å½“å‰åŸŸå');
            suggestions.push('  - é˜²ç«å¢™è®¾ç½®æ˜¯å¦å…è®¸è®¿é—®');
            suggestions.push('  - SSLè¯ä¹¦æ˜¯å¦æœ‰æ•ˆï¼ˆHTTPSç¯å¢ƒï¼‰');
            
            showResult('suggestions', suggestions.join('<br>'), 'info');
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        window.onload = function() {
            displayConfigInfo();
            generateSuggestions();
        };
    </script>
</body>
</html>